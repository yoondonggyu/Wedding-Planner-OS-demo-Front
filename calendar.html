<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ìº˜ë¦°ë” - AI Wedding Planner OS</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0d12;--card:#141517;--soft:#1a1f2e;--text:#e8ecf3;--muted:#a7b0c0;--accent:#8b5cf6;--accent-2:#22d3ee;--ok:#10b981;--warn:#f59e0b;--danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:linear-gradient(180deg,#0a0c11 0%,#0d111a 60%,#0b0d12 100%);color:var(--text);font-family:'Pretendard',system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;min-height:100vh}
    .container{width:min(1160px,92%);margin:0 auto;padding:20px 0}
    header{position:sticky;top:0;backdrop-filter:blur(10px);background-color:rgba(11,13,18,0.6);border-bottom:1px solid rgba(255,255,255,0.06);z-index:30}
    .nav{display:flex;align-items:center;justify-content:space-between;padding:14px 0}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:28px;height:28px;border-radius:8px;background:conic-gradient(from 180deg,var(--accent),var(--accent-2));box-shadow:0 0 24px rgba(139,92,246,.4)}
    .nav .links{display:flex;gap:18px;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;background:var(--soft);border:1px solid rgba(255,255,255,0.15);color:#ffffff;font-weight:500;transition:.2s ease;text-decoration:none;cursor:pointer}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,0,0,.25);background:rgba(139,92,246,0.2);border-color:rgba(139,92,246,0.4)}
    .btn.primary{background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#0b0d12;border:0;font-weight:700}
    .page-title{margin:40px 0 30px}
    .page-title h1{font-size:32px;margin:0 0 8px}
    .page-title p{color:var(--muted);font-size:16px;margin:0}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:24px;margin-bottom:20px}
    .wedding-date-section{display:flex;gap:12px;align-items:center;margin-bottom:24px;padding:16px;background:rgba(139,92,246,0.1);border-radius:12px}
    .wedding-date-section input{padding:10px;border-radius:8px;background:var(--soft);border:1px solid rgba(255,255,255,.1);color:var(--text);font-size:14px}
    .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-bottom:20px}
    .calendar-day{background:var(--soft);border:1px solid rgba(255,255,255,.1);border-radius:8px;padding:12px;min-height:100px;position:relative}
    .calendar-day.other-month{opacity:0.3}
    .calendar-day.today{border-color:var(--accent);background:rgba(139,92,246,0.1)}
    .day-number{font-weight:600;margin-bottom:8px}
    .event-item{font-size:11px;padding:4px 6px;background:var(--accent);border-radius:4px;margin-bottom:4px;cursor:pointer;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .event-item.high{background:var(--danger)}
    .event-item.medium{background:var(--warn)}
    .event-item.low{background:var(--ok)}
    .todo-section{margin-top:24px}
    .todo-item{display:flex;align-items:center;gap:12px;padding:12px;background:var(--soft);border-radius:8px;margin-bottom:8px}
    .todo-item.completed{opacity:0.5}
    .todo-checkbox{width:20px;height:20px;border-radius:4px;border:2px solid var(--accent);cursor:pointer}
    .todo-checkbox.checked{background:var(--accent)}
    .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center}
    .modal.active{display:flex}
    .modal-content{background:var(--card);border-radius:16px;padding:24px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto}
    .form-group{margin-bottom:16px}
    .form-group label{display:block;margin-bottom:6px;font-size:14px;color:var(--muted)}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border-radius:8px;background:var(--soft);border:1px solid rgba(255,255,255,.1);color:var(--text);font-size:14px;font-family:inherit}
    .form-group textarea{min-height:80px;resize:vertical}
  </style>
</head>
<body>
  <header>
    <div class="container nav">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <strong><a href="index.html" style="color:inherit;text-decoration:none">AI Wedding Planner OS</a></strong>
      </div>
      <nav class="links">
        <a href="index.html" class="btn">í™ˆ</a>
        <a href="board.html" class="btn">ê²Œì‹œíŒ</a>
        <a href="budget.html" class="btn">ì˜ˆì‚°ì„œ</a>
        <a href="chat.html" class="btn">AI í”Œë˜ë„ˆ</a>
        <a href="voice.html" class="btn">ìŒì„± ë¹„ì„œ</a>
        <span id="userInfo" style="display:none">
          <span style="color:var(--muted);font-size:14px" id="userNickname"></span>
          <a href="#" class="btn" onclick="event.preventDefault();logout()">ë¡œê·¸ì•„ì›ƒ</a>
        </span>
      </nav>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="page-title">
        <h1>ğŸ“… ê°œì¸í™” ì¼ì • ê´€ë¦¬(ìº˜ë¦°ë”)</h1>
        <p>D-Day ê¸°ë°˜ íƒ€ì„ë¼ì¸ ìë™ ìƒì„± + Todo ë¦¬ìŠ¤íŠ¸</p>
      </div>

      <!-- ì˜ˆì‹ì¼ ì„¤ì • -->
      <div class="card">
        <div class="wedding-date-section">
          <label style="font-weight:600">ì˜ˆì‹ì¼:</label>
          <input type="date" id="weddingDate" />
          <button class="btn primary" onclick="setWeddingDate()">ì„¤ì •</button>
          <button class="btn" onclick="generateTimeline()">íƒ€ì„ë¼ì¸ ìë™ ìƒì„±</button>
        </div>
        <div id="dDayInfo" style="font-size:18px;font-weight:600;color:var(--accent);margin-top:12px"></div>
      </div>

      <!-- ìº˜ë¦°ë” -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <h2 style="margin:0">ìº˜ë¦°ë”</h2>
          <div style="display:flex;gap:8px">
            <button class="btn" onclick="prevMonth()">â—€</button>
            <span id="currentMonth" style="padding:10px 16px;font-weight:600"></span>
            <button class="btn" onclick="nextMonth()">â–¶</button>
            <button class="btn primary" onclick="showEventModal()">ì¼ì • ì¶”ê°€</button>
          </div>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
      </div>

      <!-- Todo ë¦¬ìŠ¤íŠ¸ -->
      <div class="card todo-section">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h2 style="margin:0">í• ì¼ ë¦¬ìŠ¤íŠ¸</h2>
          <button class="btn primary" onclick="showTodoModal()">í• ì¼ ì¶”ê°€</button>
        </div>
        <div id="todoList"></div>
      </div>
    </div>
  </main>

  <!-- ì¼ì • ì¶”ê°€ ëª¨ë‹¬ -->
  <div class="modal" id="eventModal">
    <div class="modal-content">
      <h3 style="margin-top:0">ì¼ì • ì¶”ê°€</h3>
      <div class="form-group">
        <label>ì œëª©</label>
        <input type="text" id="eventTitle" required />
      </div>
      <div class="form-group">
        <label>ë‚ ì§œ</label>
        <input type="date" id="eventDate" required />
      </div>
      <div class="form-group">
        <label>ì‹œê°„</label>
        <input type="time" id="eventTime" />
      </div>
      <div class="form-group">
        <label>ì¹´í…Œê³ ë¦¬</label>
        <select id="eventCategory">
          <option value="general">ì¼ë°˜</option>
          <option value="payment">ê²°ì œ</option>
          <option value="meeting">ë¯¸íŒ…</option>
          <option value="fitting">í”¼íŒ…</option>
          <option value="booking">ì˜ˆì•½</option>
          <option value="preparation">ì¤€ë¹„</option>
        </select>
      </div>
      <div class="form-group">
        <label>ìš°ì„ ìˆœìœ„</label>
        <select id="eventPriority">
          <option value="low">ë‚®ìŒ</option>
          <option value="medium" selected>ë³´í†µ</option>
          <option value="high">ë†’ìŒ</option>
        </select>
      </div>
      <div class="form-group">
        <label>ë‹´ë‹¹ì</label>
        <select id="eventAssignee">
          <option value="both" selected>ê³µë™</option>
          <option value="groom">ì‹ ë‘</option>
          <option value="bride">ì‹ ë¶€</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px">
        <button class="btn" onclick="closeEventModal()">ì·¨ì†Œ</button>
        <button class="btn primary" onclick="createEvent()">ì¶”ê°€</button>
      </div>
    </div>
  </div>

  <!-- í• ì¼ ì¶”ê°€ ëª¨ë‹¬ -->
  <div class="modal" id="todoModal">
    <div class="modal-content">
      <h3 style="margin-top:0">í• ì¼ ì¶”ê°€</h3>
      <div class="form-group">
        <label>ì œëª©</label>
        <input type="text" id="todoTitle" required />
      </div>
      <div class="form-group">
        <label>ë§ˆê°ì¼</label>
        <input type="date" id="todoDueDate" />
      </div>
      <div class="form-group">
        <label>ìš°ì„ ìˆœìœ„</label>
        <select id="todoPriority">
          <option value="low">ë‚®ìŒ</option>
          <option value="medium" selected>ë³´í†µ</option>
          <option value="high">ë†’ìŒ</option>
        </select>
      </div>
      <div class="form-group">
        <label>ë‹´ë‹¹ì</label>
        <select id="todoAssignee">
          <option value="both" selected>ê³µë™</option>
          <option value="groom">ì‹ ë‘</option>
          <option value="bride">ì‹ ë¶€</option>
        </select>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:20px">
        <button class="btn" onclick="closeTodoModal()">ì·¨ì†Œ</button>
        <button class="btn primary" onclick="createTodo()">ì¶”ê°€</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE_URL = 'http://localhost:8001/api';
    let currentUser = null;
    const userId = localStorage.getItem('userId');
    const nickname = localStorage.getItem('nickname');
    let currentDate = new Date();
    let events = [];
    let todos = [];
    let weddingDate = null;

    if (userId && nickname) {
      currentUser = { id: parseInt(userId), nickname: nickname };
      updateAuthUI();
      loadData();
    } else {
      alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      window.location.href = 'index.html';
    }

    function updateAuthUI(){
      const userInfo = document.getElementById('userInfo');
      const userNickname = document.getElementById('userNickname');
      if(currentUser){
        userInfo.style.display = 'flex';
        userInfo.style.alignItems = 'center';
        userInfo.style.gap = '12px';
        userNickname.textContent = `${currentUser.nickname}ë‹˜`;
      }
    }

    function logout(){
      currentUser = null;
      localStorage.removeItem('userId');
      localStorage.removeItem('nickname');
      localStorage.removeItem('authToken');
      window.location.href = 'index.html';
    }

    async function loadData(){
      await Promise.all([
        loadEvents(),
        loadTodos(),
        loadWeddingDate()
      ]);
      renderCalendar();
      renderTodos();
    }

    async function loadWeddingDate(){
      // ì˜ˆì‹ì¼ì€ ë³„ë„ APIê°€ ì—†ìœ¼ë¯€ë¡œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ê°€ì ¸ì˜¤ê±°ë‚˜ ì´ë²¤íŠ¸ì—ì„œ ì¶”ì¶œ
      const weddingEvent = events.find(e => e.category === 'wedding' && e.d_day_offset === 0);
      if(weddingEvent){
        weddingDate = weddingEvent.start_date;
        document.getElementById('weddingDate').value = weddingDate;
        updateDDay();
      }
    }

    function updateDDay(){
      if(!weddingDate) return;
      const today = new Date();
      const wedding = new Date(weddingDate);
      const diff = Math.ceil((wedding - today) / (1000 * 60 * 60 * 24));
      const dDayInfo = document.getElementById('dDayInfo');
      if(diff > 0){
        dDayInfo.textContent = `D-${diff}`;
      } else if(diff === 0){
        dDayInfo.textContent = 'D-Day!';
      } else {
        dDayInfo.textContent = `D+${Math.abs(diff)}`;
      }
    }

    async function setWeddingDate(){
      const date = document.getElementById('weddingDate').value;
      if(!date) return alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
      
      try {
        const response = await fetch(`${API_BASE_URL}/calendar/wedding-date?user_id=${currentUser.id}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({wedding_date: date})
        });
        if(response.ok){
          weddingDate = date;
          updateDDay();
          alert('ì˜ˆì‹ì¼ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }
      } catch(e){
        console.error(e);
        alert('ì˜ˆì‹ì¼ ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function generateTimeline(){
      const date = document.getElementById('weddingDate').value;
      if(!date) return alert('ì˜ˆì‹ì¼ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.');
      
      if(!confirm('ê¸°ì¡´ ì¼ì •ì„ ëª¨ë‘ ì‚­ì œí•˜ê³  ìƒˆ íƒ€ì„ë¼ì¸ì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      
      try {
        const response = await fetch(`${API_BASE_URL}/calendar/timeline/generate?user_id=${currentUser.id}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            wedding_date: date,
            user_preferences: {}
          })
        });
        if(response.ok){
          alert('íƒ€ì„ë¼ì¸ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.');
          await loadData();
        }
      } catch(e){
        console.error(e);
        alert('íƒ€ì„ë¼ì¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function loadEvents(){
      try {
        const response = await fetch(`${API_BASE_URL}/calendar/events?user_id=${currentUser.id}`);
        const data = await response.json();
        if(data.message === 'events_retrieved'){
          events = data.data.events;
        }
      } catch(e){
        console.error('ì¼ì • ë¡œë“œ ì‹¤íŒ¨:', e);
      }
    }

    async function loadTodos(){
      try {
        const response = await fetch(`${API_BASE_URL}/calendar/todos?user_id=${currentUser.id}&completed=false`);
        const data = await response.json();
        if(data.message === 'todos_retrieved'){
          todos = data.data.todos;
        }
      } catch(e){
        console.error('í• ì¼ ë¡œë“œ ì‹¤íŒ¨:', e);
      }
    }

    function renderCalendar(){
      const year = currentDate.getFullYear();
      const month = currentDate.getMonth();
      document.getElementById('currentMonth').textContent = `${year}ë…„ ${month + 1}ì›”`;
      
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const startDate = new Date(firstDay);
      startDate.setDate(startDate.getDate() - startDate.getDay());
      
      const grid = document.getElementById('calendarGrid');
      grid.innerHTML = '';
      
      const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      dayNames.forEach(day => {
        const header = document.createElement('div');
        header.style.textAlign = 'center';
        header.style.fontWeight = '600';
        header.style.padding = '8px';
        header.textContent = day;
        grid.appendChild(header);
      });
      
      for(let i = 0; i < 42; i++){
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        
        const dayDiv = document.createElement('div');
        dayDiv.className = 'calendar-day';
        if(date.getMonth() !== month) dayDiv.classList.add('other-month');
        if(date.toDateString() === new Date().toDateString()) dayDiv.classList.add('today');
        
        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = date.getDate();
        dayDiv.appendChild(dayNumber);
        
        const dateStr = date.toISOString().split('T')[0];
        const dayEvents = events.filter(e => e.start_date === dateStr);
        dayEvents.forEach(event => {
          const eventDiv = document.createElement('div');
          eventDiv.className = `event-item ${event.priority}`;
          eventDiv.textContent = event.title;
          eventDiv.title = event.description || event.title;
          dayDiv.appendChild(eventDiv);
        });
        
        grid.appendChild(dayDiv);
      }
    }

    function renderTodos(){
      const todoList = document.getElementById('todoList');
      todoList.innerHTML = '';
      
      if(todos.length === 0){
        todoList.innerHTML = '<div style="text-align:center;color:var(--muted);padding:40px">í• ì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      
      todos.forEach(todo => {
        const todoDiv = document.createElement('div');
        todoDiv.className = `todo-item ${todo.is_completed ? 'completed' : ''}`;
        
        const checkbox = document.createElement('div');
        checkbox.className = `todo-checkbox ${todo.is_completed ? 'checked' : ''}`;
        checkbox.onclick = () => toggleTodo(todo.id);
        
        const content = document.createElement('div');
        content.style.flex = '1';
        content.innerHTML = `
          <div style="font-weight:600;margin-bottom:4px">${todo.title}</div>
          ${todo.due_date ? `<div style="font-size:12px;color:var(--muted)">ë§ˆê°: ${todo.due_date}</div>` : ''}
        `;
        
        const priority = document.createElement('div');
        priority.style.padding = '4px 8px';
        priority.style.borderRadius = '4px';
        priority.style.fontSize = '12px';
        priority.style.background = todo.priority === 'high' ? 'var(--danger)' : todo.priority === 'medium' ? 'var(--warn)' : 'var(--ok)';
        priority.textContent = todo.priority === 'high' ? 'ë†’ìŒ' : todo.priority === 'medium' ? 'ë³´í†µ' : 'ë‚®ìŒ';
        
        todoDiv.appendChild(checkbox);
        todoDiv.appendChild(content);
        todoDiv.appendChild(priority);
        todoList.appendChild(todoDiv);
      });
    }

    function prevMonth(){
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar();
    }

    function nextMonth(){
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar();
    }

    function showEventModal(){
      document.getElementById('eventModal').classList.add('active');
      document.getElementById('eventDate').value = new Date().toISOString().split('T')[0];
    }

    function closeEventModal(){
      document.getElementById('eventModal').classList.remove('active');
    }

    function showTodoModal(){
      document.getElementById('todoModal').classList.add('active');
    }

    function closeTodoModal(){
      document.getElementById('todoModal').classList.remove('active');
    }

    async function createEvent(){
      const title = document.getElementById('eventTitle').value;
      const date = document.getElementById('eventDate').value;
      if(!title || !date) return alert('ì œëª©ê³¼ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      
      try {
        const response = await fetch(`${API_BASE_URL}/calendar/events?user_id=${currentUser.id}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            title: title,
            start_date: date,
            start_time: document.getElementById('eventTime').value || null,
            category: document.getElementById('eventCategory').value,
            priority: document.getElementById('eventPriority').value,
            assignee: document.getElementById('eventAssignee').value
          })
        });
        if(response.ok){
          closeEventModal();
          await loadData();
        }
      } catch(e){
        console.error(e);
        alert('ì¼ì • ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function createTodo(){
      const title = document.getElementById('todoTitle').value;
      if(!title) return alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      
      try {
        const response = await fetch(`${API_BASE_URL}/calendar/todos?user_id=${currentUser.id}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            title: title,
            due_date: document.getElementById('todoDueDate').value || null,
            priority: document.getElementById('todoPriority').value,
            assignee: document.getElementById('todoAssignee').value
          })
        });
        if(response.ok){
          closeTodoModal();
          await loadData();
        }
      } catch(e){
        console.error(e);
        alert('í• ì¼ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function toggleTodo(todoId){
      const todo = todos.find(t => t.id === todoId);
      if(!todo) return;
      
      try {
        const response = await fetch(`${API_BASE_URL}/calendar/todos/${todoId}?user_id=${currentUser.id}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            is_completed: !todo.is_completed
          })
        });
        if(response.ok){
          await loadData();
        }
      } catch(e){
        console.error(e);
      }
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('eventModal').addEventListener('click', (e) => {
      if(e.target.id === 'eventModal') closeEventModal();
    });
    document.getElementById('todoModal').addEventListener('click', (e) => {
      if(e.target.id === 'todoModal') closeTodoModal();
    });
  </script>
</body>
</html>
