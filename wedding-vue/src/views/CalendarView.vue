<script setup lang="ts">
import { computed, nextTick, onMounted, ref, watch } from 'vue'
import { useAuthStore } from '@/stores/auth'
import { useApi } from '@/composables/useApi'

interface CalendarEvent {
  id: number
  title: string
  start_date: string
  start_time?: string | null
  end_date?: string | null
  end_time?: string | null
  category: string
  priority: 'low' | 'medium' | 'high'
  assignee?: string | null
  description?: string | null
      is_completed?: boolean
      // is_auto_generatedëŠ” DBì— ì—†ìœ¼ë¯€ë¡œ ì œê±°
    }

interface Todo {
  id: number
  title: string
  due_date?: string | null
  priority: 'low' | 'medium' | 'high'
  assignee?: string | null
  description?: string | null
  is_completed: boolean
}

const authStore = useAuthStore()
const { request } = useApi()

const currentDate = ref(new Date())
const events = ref<CalendarEvent[]>([])
const todos = ref<Todo[]>([])
const weddingDate = ref<string | null>(null)
const dDay = ref<number | null>(null)
const showAutoGeneratedEvents = ref(true) // ìë™ ìƒì„±ëœ ì¼ì • í‘œì‹œ ì—¬ë¶€
// ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ ì„ íƒê°’ìœ¼ë¡œ ì„¤ì •
const today = new Date()
const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`
const selectedDate = ref<string | null>(todayStr) // ì„ íƒëœ ë‚ ì§œ (í• ì¼ ë¦¬ìŠ¤íŠ¸ í•„í„°ë§ìš©) - ê¸°ë³¸ê°’: ì˜¤ëŠ˜

const ASSIGNEE_COLORS = {
  groom: {
    background: '#3b82f6',
    border: 'rgba(59, 130, 246, 0.4)',
    shadow: 'rgba(59, 130, 246, 0.35)',
  },
  bride: {
    background: '#ec4899',
    border: 'rgba(236, 72, 153, 0.4)',
    shadow: 'rgba(236, 72, 153, 0.35)',
  },
  both: {
    background: '#8b5cf6',
    border: 'rgba(139, 92, 246, 0.4)',
    shadow: 'rgba(139, 92, 246, 0.35)',
  },
} as const

const showEventModal = ref(false)
const editingEventId = ref<number | null>(null)

const eventForm = ref({
  title: '',
  start_date: new Date().toISOString().split('T')[0],
  start_time: '',
  timeHour: '',
  timeMinute: '',
  timePeriod: 'AM' as 'AM' | 'PM',
  category: 'general',
  priority: 'medium' as 'low' | 'medium' | 'high',
  assignee: 'both',
  description: '',
})

const todoForm = ref({
  title: '',
  due_date: '',
  priority: 'medium' as 'low' | 'medium' | 'high',
  assignee: 'both',
  description: '',
  show_in_calendar: false, // ìº˜ë¦°ë”ì— í‘œì‹œ ì—¬ë¶€
})

const currentMonthText = computed(() => {
  const year = currentDate.value.getFullYear()
  const month = currentDate.value.getMonth() + 1
  return `${year}ë…„ ${month}ì›”`
})

const calendarDays = computed(() => {
  const year = currentDate.value.getFullYear()
  const month = currentDate.value.getMonth()
  const firstDay = new Date(year, month, 1)
  const lastDay = new Date(year, month + 1, 0)
  const startDate = new Date(firstDay)
  startDate.setDate(startDate.getDate() - startDate.getDay())

  const days: Array<{
    date: Date
    isCurrentMonth: boolean
    isToday: boolean
    events: CalendarEvent[]
  }> = []

  for (let i = 0; i < 42; i++) {
    const date = new Date(startDate)
    date.setDate(startDate.getDate() + i)
    // íƒ€ì„ì¡´ ë³€í™˜ ì—†ì´ ë¡œì»¬ ë‚ ì§œë¡œ ì§ì ‘ í¬ë§·íŒ…
    const year = date.getFullYear()
    const month = String(date.getMonth() + 1).padStart(2, '0')
    const day = String(date.getDate()).padStart(2, '0')
    const dateStr = `${year}-${month}-${day}`
    
    let dayEvents = events.value.filter((e) => e.start_date === dateStr)
    
    // í• ì¼ì€ ì´ì œ ì¼ì •ìœ¼ë¡œ í†µí•©ë˜ì—ˆìœ¼ë¯€ë¡œ ë³„ë„ ì²˜ë¦¬ ë¶ˆí•„ìš”
    
    // ì˜ˆì‹ì¼ì´ ì„¤ì •ë˜ì–´ ìˆê³  í•´ë‹¹ ë‚ ì§œë©´ ì˜ˆì‹ì¼ ì¼ì • ì¶”ê°€
    if (weddingDate.value && weddingDate.value === dateStr) {
      const hasWeddingEvent = dayEvents.some((e) => e.title.includes('ì˜ˆì‹ì¼') || e.category === 'wedding')
      if (!hasWeddingEvent) {
        dayEvents = [
          ...dayEvents,
          {
            id: -1, // ì„ì‹œ ID (ì˜ˆì‹ì¼ í‘œì‹œìš©)
            title: 'ì˜ˆì‹ì¼',
            start_date: dateStr,
            category: 'wedding',
            priority: 'high' as const,
            assignee: 'both',
            description: 'ì˜ˆì‹ì¼',
          } as CalendarEvent,
        ]
      }
    }
    
        // ìë™ ìƒì„±ëœ ì¼ì • í•„í„°ë§ì€ DBì— is_auto_generated ì»¬ëŸ¼ì´ ì—†ìœ¼ë¯€ë¡œ ì œê±°
        // í•„ìš”ì‹œ ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ í•„í„°ë§ ê°€ëŠ¥
    
    const isToday =
      date.toDateString() === new Date().toDateString()

    days.push({
      date,
      isCurrentMonth: date.getMonth() === month,
      isToday,
      events: dayEvents,
    })
  }

  return days
})

const canAccess = computed(() => authStore.isAuthenticated)

// ë¡œê·¸ì¸ ìƒíƒœ ë³€ê²½ ê°ì§€ - ì‚¬ìš©ì ID ë³€ê²½ ì‹œ
watch(
  () => authStore.user?.id,
  (newUserId, oldUserId) => {
    console.log('watch user.id:', { newUserId, oldUserId, isAuthenticated: authStore.isAuthenticated })
    
    // ë¡œê·¸ì•„ì›ƒ ì‹œ ë°ì´í„° ì´ˆê¸°í™”
    if (!newUserId && oldUserId) {
      console.log('ë¡œê·¸ì•„ì›ƒ ê°ì§€ - ë°ì´í„° ì´ˆê¸°í™”')
      events.value = []
      todos.value = []
      weddingDate.value = null
      dDay.value = null
      return
    }
    
    // ë¡œê·¸ì¸ ì‹œ ë˜ëŠ” ì‚¬ìš©ì ë³€ê²½ ì‹œ ë°ì´í„° ë¡œë“œ
    if (newUserId && newUserId !== oldUserId) {
      console.log('ì‚¬ìš©ì ID ë³€ê²½ ê°ì§€ - ë°ì´í„° ë¡œë“œ ì˜ˆì •:', { oldUserId, newUserId })
      // nextTickì„ ì‚¬ìš©í•˜ì—¬ Vueì˜ ë°˜ì‘ì„± ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œëœ í›„ ì‹¤í–‰
      nextTick(() => {
        if (authStore.user?.id === newUserId && authStore.isAuthenticated) {
          console.log('ì‚¬ìš©ì ID ë³€ê²½ í›„ ë°ì´í„° ë¡œë“œ ì‹¤í–‰')
          loadData()
        } else {
          console.warn('ì‚¬ìš©ì ID ë³€ê²½ í›„ ì¡°ê±´ ë¶ˆì¼ì¹˜:', {
            currentUserId: authStore.user?.id,
            expectedUserId: newUserId,
            isAuthenticated: authStore.isAuthenticated
          })
        }
      })
    }
  },
  { immediate: false }
)

// ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€
watch(
  () => authStore.isAuthenticated,
  (isAuth, wasAuth) => {
    console.log('watch isAuthenticated:', { isAuth, wasAuth, userId: authStore.user?.id })
    
    if (!isAuth && wasAuth) {
      // ë¡œê·¸ì•„ì›ƒ ì‹œ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”
      console.log('ë¡œê·¸ì•„ì›ƒ ê°ì§€ - ë°ì´í„° ì´ˆê¸°í™”')
      events.value = []
      todos.value = []
      weddingDate.value = null
      dDay.value = null
    } else if (isAuth && !wasAuth) {
      // ë¡œê·¸ì¸ ì‹œ ë°ì´í„° ë¡œë“œ (ì´ì „ì— ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ì„ ë•Œë§Œ)
      const userId = authStore.user?.id
      console.log('ë¡œê·¸ì¸ ê°ì§€ - ë°ì´í„° ë¡œë“œ ì˜ˆì •:', { userId })
      
      if (userId) {
        // nextTickì„ ì‚¬ìš©í•˜ì—¬ Vueì˜ ë°˜ì‘ì„± ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œëœ í›„ ì‹¤í–‰
        nextTick(() => {
          if (authStore.isAuthenticated && authStore.user?.id === userId) {
            console.log('ë¡œê·¸ì¸ í›„ ë°ì´í„° ë¡œë“œ ì‹¤í–‰')
            loadData()
          } else {
            console.warn('ë¡œê·¸ì¸ í›„ ì¡°ê±´ ë¶ˆì¼ì¹˜:', {
              isAuthenticated: authStore.isAuthenticated,
              userId: authStore.user?.id,
              expectedUserId: userId
            })
          }
        })
      } else {
        console.warn('ë¡œê·¸ì¸ ê°ì§€ë˜ì—ˆì§€ë§Œ ì‚¬ìš©ì IDê°€ ì—†ìŠµë‹ˆë‹¤.')
      }
    }
  }
)

onMounted(() => {
  console.log('CalendarView onMounted:', {
    isAuthenticated: authStore.isAuthenticated,
    userId: authStore.user?.id,
    canAccess: canAccess.value
  })
  
  if (!canAccess.value) {
    authStore.openLoginModal()
    return
  }
  
  // ë¡œê·¸ì¸ ìƒíƒœë©´ ë°ì´í„° ë¡œë“œ
  if (authStore.user?.id) {
    console.log('onMounted: ì‚¬ìš©ì IDê°€ ìˆìœ¼ë¯€ë¡œ ë°ì´í„° ë¡œë“œ ì‹œì‘')
    loadData()
  } else {
    console.warn('onMounted: ì‚¬ìš©ì IDê°€ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ ëª¨ë‹¬ì„ ì—½ë‹ˆë‹¤.')
  }
})

async function loadData() {
  const userId = authStore.user?.id
  if (!userId) {
    console.warn('loadData: ì‚¬ìš©ì IDê°€ ì—†ì–´ì„œ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')
    return
  }
  
  console.log('loadData: ë°ì´í„° ë¡œë“œ ì‹œì‘, user_id:', userId)
  try {
    await Promise.all([loadEvents(), loadWeddingDate()])
    updateDDay()
    // í• ì¼ì€ ì¼ì • ë¡œë“œ í›„ì— ë¡œë“œ (ì¼ì • ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ)
    await loadTodos()
    console.log('loadData: ëª¨ë“  ë°ì´í„° ë¡œë“œ ì™„ë£Œ', {
      eventsCount: events.value.length,
      todosCount: todos.value.length,
      weddingDate: weddingDate.value,
      selectedDate: selectedDate.value
    })
  } catch (err) {
    console.error('loadData: ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', err)
  }
}

async function loadWeddingDate() {
  if (!authStore.user?.id) {
    weddingDate.value = null
    dDay.value = null
    console.log('loadWeddingDate: ì‚¬ìš©ì ID ì—†ìŒ')
    return
  }
  
  try {
    console.log('loadWeddingDate: ì˜ˆì‹ì¼ ì¡°íšŒ ì‹œì‘, user_id:', authStore.user.id)
    const res = await request<{ message: string; data: { wedding_date: string | null } }>(
      `/calendar/wedding-date`,
      { method: 'GET' }
    )
    console.log('loadWeddingDate: ì‘ë‹µ ë°›ìŒ:', JSON.stringify(res, null, 2))
    
    // ì‘ë‹µ í˜•ì‹ í™•ì¸
    if (res && typeof res === 'object') {
      if ('message' in res && res.message === 'wedding_date_retrieved') {
        if (res.data && res.data.wedding_date) {
          weddingDate.value = res.data.wedding_date
          console.log('loadWeddingDate: ì˜ˆì‹ì¼ ë¡œë“œ ì„±ê³µ:', weddingDate.value)
          updateDDay()
        } else {
          weddingDate.value = null
          console.log('loadWeddingDate: ì˜ˆì‹ì¼ ì—†ìŒ (data.wedding_dateê°€ null)')
        }
      } else {
        console.warn('loadWeddingDate: ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ í˜•ì‹:', res)
        weddingDate.value = null
      }
    } else {
      console.error('loadWeddingDate: ì‘ë‹µì´ ê°ì²´ê°€ ì•„ë‹˜:', res)
      weddingDate.value = null
    }
  } catch (err: any) {
    console.error('ì˜ˆì‹ì¼ ë¡œë“œ ì‹¤íŒ¨:', err)
    console.error('ì˜ˆì‹ì¼ ë¡œë“œ ì‹¤íŒ¨ ìƒì„¸:', {
      message: err?.message,
      data: err?.data,
      response: err?.response,
      status: err?.status
    })
    weddingDate.value = null
    dDay.value = null
  }
}

function updateDDay() {
  if (!weddingDate.value) {
    dDay.value = null
    return
  }
  
  // íƒ€ì„ì¡´ ë³€í™˜ ì—†ì´ ë‚ ì§œë§Œ ë¹„êµ
  const [year, month, day] = weddingDate.value.split('-').map(Number)
  const wedding = new Date(year, month - 1, day)
  wedding.setHours(0, 0, 0, 0)
  
  const today = new Date()
  today.setHours(0, 0, 0, 0)
  
  const diff = Math.ceil((wedding.getTime() - today.getTime()) / (1000 * 60 * 60 * 24))
  dDay.value = diff
}

async function setWeddingDate() {
  const date = weddingDate.value
  if (!date || !date.match(/^\d{4}-\d{2}-\d{2}$/)) {
    alert('ì˜¬ë°”ë¥¸ ë‚ ì§œ í˜•ì‹(YYYY-MM-DD)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.')
    return
  }

  // ë‚ ì§œ ìœ íš¨ì„± ê²€ì¦ (íƒ€ì„ì¡´ ë³€í™˜ ì—†ì´ ì§ì ‘ íŒŒì‹±)
  const [year, month, day] = date.split('-').map(Number)
  const dateObj = new Date(year, month - 1, day)
  if (
    dateObj.getFullYear() !== year ||
    dateObj.getMonth() !== month - 1 ||
    dateObj.getDate() !== day
  ) {
    alert('ìœ íš¨í•˜ì§€ ì•Šì€ ë‚ ì§œì…ë‹ˆë‹¤.')
    return
  }

  try {
    console.log('ì˜ˆì‹ì¼ ì„¤ì • ìš”ì²­ (ì…ë ¥ê°’):', date, 'user_id:', authStore.user!.id)
    
    const res = await request<{ message: string; data: { wedding_date: string } }>(
      `/calendar/wedding-date`,
      {
        method: 'POST',
        body: { wedding_date: date },
      }
    )
    
    console.log('ì˜ˆì‹ì¼ ì„¤ì • ì‘ë‹µ:', res)
    
    // ì˜ˆì‹ì¼ ì„¤ì • í›„ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
    if (res.message === 'wedding_date_set' && res.data?.wedding_date) {
      // ì‘ë‹µì—ì„œ ë°›ì€ ë‚ ì§œë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© (ì…ë ¥í•œ ë‚ ì§œ ê·¸ëŒ€ë¡œ)
      const savedDate = res.data.wedding_date
      weddingDate.value = savedDate
      updateDDay()
      
      // ìº˜ë¦°ë”ë¥¼ ì˜ˆì‹ì¼ì´ ìˆëŠ” ì›”ë¡œ ì´ë™ (íƒ€ì„ì¡´ ë³€í™˜ ì—†ì´ ì§ì ‘ íŒŒì‹±)
      const [savedYear, savedMonth] = savedDate.split('-').map(Number)
      currentDate.value = new Date(savedYear, savedMonth - 1, 1)
      
      // ë‚ ì§œ í¬ë§·íŒ… (2025ë…„ 11ì›” 25ì¼) - ì €ì¥ëœ ë‚ ì§œì—ì„œ ì§ì ‘ íŒŒì‹±
      const [displayYear, displayMonth, displayDay] = savedDate.split('-').map(Number)
      const formattedDate = `${displayYear}ë…„ ${displayMonth}ì›” ${displayDay}ì¼`
      
      console.log('ì„¤ì •ëœ ì˜ˆì‹ì¼:', savedDate, 'í‘œì‹œ:', formattedDate)
      
      // ê°„ë‹¨í•œ í™•ì¸ ë©”ì‹œì§€
      alert(`ì˜ˆì‹ì¼ì´ ${formattedDate}ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n"íƒ€ì„ë¼ì¸ ìë™ ìƒì„±" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¼ì •ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`)
    } else {
      console.error('ì˜ˆì‹ì¼ ì„¤ì • ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜:', res)
      throw new Error('ì˜ˆì‹ì¼ ì„¤ì • ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.')
    }
  } catch (err: any) {
    console.error('ì˜ˆì‹ì¼ ì„¤ì • ì‹¤íŒ¨:', err)
    console.error('ì˜ˆì‹ì¼ ì„¤ì • ì‹¤íŒ¨ ìƒì„¸:', {
      message: err?.message,
      data: err?.data,
      response: err?.response,
      stack: err?.stack
    })
    const errorMessage = err?.data?.message || err?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'
    alert(`ì˜ˆì‹ì¼ ì„¤ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì˜¤ë¥˜: ${errorMessage}`)
  }
}

async function generateTimeline() {
  // ì˜ˆì‹ì¼ í™•ì¸ - weddingDate.valueê°€ ì—†ìœ¼ë©´ DBì—ì„œ ë‹¤ì‹œ ë¡œë“œ ì‹œë„
  let targetDate = weddingDate.value
  if (!targetDate) {
    try {
      const res = await request<{ data: { wedding_date: string | null } }>(
        `/calendar/wedding-date`,
        { method: 'GET' }
      )
      if (res.data?.wedding_date) {
        targetDate = res.data.wedding_date
        weddingDate.value = targetDate
      } else {
        alert('ì˜ˆì‹ì¼ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.')
        return
      }
    } catch (err) {
      console.error('ì˜ˆì‹ì¼ ë¡œë“œ ì‹¤íŒ¨:', err)
      alert('ì˜ˆì‹ì¼ì„ ë¨¼ì € ì„¤ì •í•´ì£¼ì„¸ìš”.')
      return
    }
  }

  // ê¸°ì¡´ ì¼ì •ì´ ìˆìœ¼ë©´ í™•ì¸
  if (events.value.length > 0) {
    if (!confirm('ê¸°ì¡´ ì¼ì •ì„ ëª¨ë‘ ì‚­ì œí•˜ê³  ìƒˆ íƒ€ì„ë¼ì¸ì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return
  }

  try {
    const response = await request(`/calendar/timeline/generate`, {
      method: 'POST',
      body: {
        wedding_date: targetDate,
        user_preferences: {},
      },
    })
    
    // ì‘ë‹µ í™•ì¸
    if (response.message === 'timeline_generated' || response.message === 'timeline_created') {
      alert('íƒ€ì„ë¼ì¸ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.')
      await loadData()
    } else {
      throw new Error('íƒ€ì„ë¼ì¸ ìƒì„± ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.')
    }
  } catch (err: any) {
    console.error('íƒ€ì„ë¼ì¸ ìƒì„± ì‹¤íŒ¨:', err)
    const errorMessage = err?.data?.message || err?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'
    alert(`íƒ€ì„ë¼ì¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nì˜¤ë¥˜: ${errorMessage}`)
  }
}

    async function loadEvents() {
      const userId = authStore.user?.id
      if (!userId) {
        console.log('loadEvents: ì‚¬ìš©ì IDê°€ ì—†ì–´ì„œ ì¼ì •ì„ ë¡œë“œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')
        events.value = []
        return
      }
      
      try {
        console.log('loadEvents: ì¼ì • ë¡œë“œ ì‹œì‘, user_id:', userId)
        const res = await request<{ message: string; data: { events: CalendarEvent[] } }>(
          `/calendar/todos`,
          { method: 'GET' }
        )
        if (res.message === 'todos_retrieved') {
          events.value = res.data.events || []
          console.log('loadEvents: ì¼ì • ë¡œë“œ ì™„ë£Œ, ê°œìˆ˜:', events.value.length)
        } else {
          console.warn('loadEvents: ì˜ˆìƒí•˜ì§€ ëª»í•œ ì‘ë‹µ:', res.message)
          events.value = []
        }
      } catch (err) {
        console.error('ì¼ì • ë¡œë“œ ì‹¤íŒ¨:', err)
        events.value = []
      }
    }

async function loadTodos() {
  const userId = authStore.user?.id
  if (!userId) {
    console.log('loadTodos: ì‚¬ìš©ì IDê°€ ì—†ì–´ì„œ í• ì¼ì„ ë¡œë“œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')
    todos.value = []
    return
  }
  
  try {
    console.log('loadTodos: í• ì¼ ë¡œë“œ ì‹œì‘, user_id:', userId, 'ì„ íƒëœ ë‚ ì§œ:', selectedDate.value)
    
    // ì„ íƒëœ ë‚ ì§œê°€ ìˆìœ¼ë©´ í•´ë‹¹ ë‚ ì§œì˜ ëª¨ë“  ì¼ì •ì„ í‘œì‹œ
    if (selectedDate.value) {
      // ì„ íƒëœ ë‚ ì§œì˜ ì¼ì •ë§Œ í•„í„°ë§
      const dayEvents = events.value.filter((e) => e.start_date === selectedDate.value)
      todos.value = dayEvents.map((event) => ({
        id: event.id,
        title: event.title,
        due_date: event.start_date,
        priority: event.priority,
        assignee: event.assignee || 'both',
        description: event.description || null,
        is_completed: event.is_completed || false,
      }))
      console.log('loadTodos: ì„ íƒëœ ë‚ ì§œì˜ ì¼ì • ë¡œë“œ ì™„ë£Œ, ê°œìˆ˜:', todos.value.length)
    } else {
      // ì„ íƒëœ ë‚ ì§œê°€ ì—†ìœ¼ë©´ categoryê°€ 'todo'ì¸ ì¼ì •ë§Œ í‘œì‹œ
      const todoEvents = events.value.filter((e) => e.category === 'todo')
      todos.value = todoEvents.map((event) => ({
        id: event.id,
        title: event.title,
        due_date: event.start_date,
        priority: event.priority,
        assignee: event.assignee || 'both',
        description: event.description || null,
        is_completed: event.is_completed || false,
      }))
      console.log('loadTodos: í• ì¼ ë¡œë“œ ì™„ë£Œ, ê°œìˆ˜:', todos.value.length)
    }
  } catch (err) {
    console.error('í• ì¼ ë¡œë“œ ì‹¤íŒ¨:', err)
    todos.value = []
  }
}

// ë‚ ì§œ í´ë¦­ í•¸ë“¤ëŸ¬
function handleDateClick(dateStr: string) {
  if (selectedDate.value === dateStr) {
    // ê°™ì€ ë‚ ì§œë¥¼ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ì„ íƒ í•´ì œ
    selectedDate.value = null
  } else {
    // ë‹¤ë¥¸ ë‚ ì§œ í´ë¦­ ì‹œ ì„ íƒ
    selectedDate.value = dateStr
  }
  // í• ì¼ ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨
  loadTodos()
}

function prevMonth() {
  currentDate.value = new Date(currentDate.value.getFullYear(), currentDate.value.getMonth() - 1, 1)
}

function nextMonth() {
  currentDate.value = new Date(currentDate.value.getFullYear(), currentDate.value.getMonth() + 1, 1)
}

function parseTimeTo12Hour(time24: string | null | undefined): { hour: string; minute: string; period: 'AM' | 'PM' } {
  if (!time24) {
    return { hour: '', minute: '', period: 'AM' }
  }
  const [hour, minute] = time24.split(':')
  const hourNum = parseInt(hour, 10)
  if (hourNum === 0) {
    return { hour: '12', minute: minute || '', period: 'AM' }
  } else if (hourNum < 12) {
    return { hour: hour, minute: minute || '', period: 'AM' }
  } else if (hourNum === 12) {
    return { hour: '12', minute: minute || '', period: 'PM' }
  } else {
    return { hour: String(hourNum - 12), minute: minute || '', period: 'PM' }
  }
}

function formatTimeTo24Hour(hour: string, minute: string, period: 'AM' | 'PM'): string {
  if (!hour || !minute) return ''
  let hourNum = parseInt(hour, 10)
  if (isNaN(hourNum) || hourNum < 1 || hourNum > 12) return ''
  if (period === 'PM' && hourNum !== 12) {
    hourNum += 12
  } else if (period === 'AM' && hourNum === 12) {
    hourNum = 0
  }
  const minuteNum = parseInt(minute, 10)
  if (isNaN(minuteNum) || minuteNum < 0 || minuteNum > 59) return ''
  return `${String(hourNum).padStart(2, '0')}:${String(minuteNum).padStart(2, '0')}`
}

function openEventModal(event?: CalendarEvent) {
  if (event) {
    editingEventId.value = event.id
    const timeParts = parseTimeTo12Hour(event.start_time)
    eventForm.value = {
      title: event.title,
      start_date: event.start_date,
      start_time: event.start_time || '',
      timeHour: timeParts.hour,
      timeMinute: timeParts.minute,
      timePeriod: timeParts.period,
      category: event.category || 'general',
      priority: event.priority,
      assignee: event.assignee || 'both',
      description: event.description || '',
    }
  } else {
    editingEventId.value = null
    eventForm.value = {
      title: '',
      start_date: new Date().toISOString().split('T')[0],
      start_time: '',
      timeHour: '',
      timeMinute: '',
      timePeriod: 'AM',
      category: 'general',
      priority: 'medium',
      assignee: 'both',
      description: '',
    }
  }
  showEventModal.value = true
}

function closeEventModal() {
  showEventModal.value = false
  editingEventId.value = null
}

function openTodoModal(todo?: Todo) {
  // í• ì¼ë„ ì¼ì •ìœ¼ë¡œ í†µí•© - ì¼ì • ëª¨ë‹¬ ì—´ê¸°
  if (todo) {
    // í• ì¼ì„ ì¼ì •ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
    const event: CalendarEvent = {
      id: todo.id,
      title: todo.title,
      start_date: todo.due_date || new Date().toISOString().split('T')[0],
      start_time: null,
      end_date: null,
      end_time: null,
      category: 'todo',
      priority: todo.priority,
      assignee: todo.assignee || 'both',
      description: todo.description || null,
      is_completed: todo.is_completed,
    }
    openEventModal(event)
  } else {
    // ìƒˆ í• ì¼ ì¶”ê°€ - ì¼ì • ëª¨ë‹¬ ì—´ê¸° (category: 'todo')
    editingEventId.value = null
    eventForm.value = {
      title: '',
      start_date: new Date().toISOString().split('T')[0],
      start_time: '',
      timeHour: '',
      timeMinute: '',
      timePeriod: 'AM',
      category: 'todo', // í• ì¼ì€ categoryë¥¼ 'todo'ë¡œ ì„¤ì •
      priority: 'medium',
      assignee: 'both',
      description: '',
    }
    showEventModal.value = true
  }
}

// closeTodoModal í•¨ìˆ˜ëŠ” ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ - closeEventModalë¡œ í†µí•©ë¨

async function createEvent() {
  if (!eventForm.value.title || !eventForm.value.start_date) {
    alert('ì œëª©ê³¼ ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.')
    return
  }

  try {
    // ì‹œê°„ í¬ë§·íŒ… (12ì‹œê°„ í˜•ì‹ -> 24ì‹œê°„ í˜•ì‹)
    const time24 = formatTimeTo24Hour(
      eventForm.value.timeHour,
      eventForm.value.timeMinute,
      eventForm.value.timePeriod
    )

    if (editingEventId.value) {
      // ìˆ˜ì •
      await request(`/calendar/todos/${editingEventId.value}`, {
        method: 'PUT',
        body: {
          title: eventForm.value.title,
          start_date: eventForm.value.start_date,
          start_time: time24 || null,
          category: eventForm.value.category,
          priority: eventForm.value.priority,
          assignee: eventForm.value.assignee,
          description: eventForm.value.description || null,
          is_completed: eventForm.value.is_completed,
        },
      })
      alert('ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.')
    } else {
      // ìƒì„±
      await request(`/calendar/todos`, {
        method: 'POST',
        body: {
          title: eventForm.value.title,
          start_date: eventForm.value.start_date,
          start_time: time24 || null,
          category: eventForm.value.category,
          priority: eventForm.value.priority,
          assignee: eventForm.value.assignee,
          description: eventForm.value.description || null,
          is_completed: eventForm.value.is_completed,
        },
      })
      alert('ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.')
    }
    closeEventModal()
    await loadData()
  } catch (err) {
    console.error(err)
    alert(editingEventId.value ? 'ì¼ì • ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' : 'ì¼ì • ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')
  }
}

async function deleteEvent(eventId: number) {
  if (!confirm('ì •ë§ ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return

  try {
    await request(`/calendar/todos/${eventId}`, {
      method: 'DELETE',
    })
    // ëª¨ë‹¬ ì¦‰ì‹œ ë‹«ê¸°
    closeEventModal()
    await loadData()
    alert('ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.')
  } catch (err) {
    console.error(err)
    alert('ì¼ì • ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')
  }
}

// createTodo í•¨ìˆ˜ëŠ” ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ - createEventë¡œ í†µí•©ë¨

async function deleteTodo(todoId: number) {
  if (!confirm('ì •ë§ ì´ í• ì¼ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return

  try {
    // í• ì¼ë„ ì¼ì •ìœ¼ë¡œ í†µí•©ë˜ì—ˆìœ¼ë¯€ë¡œ todos API ì‚¬ìš©
    await request(`/calendar/todos/${todoId}`, {
      method: 'DELETE',
    })
    // í• ì¼ ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨
    await loadData()
    // ìº˜ë¦°ë”ë„ ì—…ë°ì´íŠ¸
    await loadEvents()
    alert('í• ì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.')
  } catch (err) {
    console.error('í• ì¼ ì‚­ì œ ì˜¤ë¥˜:', err)
    alert('í• ì¼ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')
  }
}

async function toggleTodo(todoId: number) {
  const todo = todos.value.find((t) => t.id === todoId)
  if (!todo) return

  try {
    // í• ì¼ë„ ì¼ì •ìœ¼ë¡œ í†µí•©ë˜ì—ˆìœ¼ë¯€ë¡œ todos API ì‚¬ìš©
    await request(`/calendar/todos/${todoId}`, {
      method: 'PUT',
      body: {
        is_completed: !todo.is_completed,
      },
    })
    // í• ì¼ ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨
    await loadTodos()
    // ìº˜ë¦°ë”ë„ ì—…ë°ì´íŠ¸
    await loadEvents()
  } catch (err) {
    console.error('í• ì¼ ìƒíƒœ ë³€ê²½ ì˜¤ë¥˜:', err)
    alert('í• ì¼ ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.')
  }
}

function getPriorityClass(priority: string) {
  return priority === 'high' ? 'high' : priority === 'medium' ? 'medium' : 'low'
}

function getAssigneeClass(assignee: string | null | undefined) {
  if (assignee === 'groom') return 'assignee-groom'
  if (assignee === 'bride') return 'assignee-bride'
  return 'assignee-both'
}

function getEventStyle(event: CalendarEvent) {
  // ì˜ˆì‹ì¼ì€ ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€
  if (event.category === 'wedding' || event.id === -1) {
    return {}
  }

  // í• ì¼ì€ ë‹¤ë¥¸ ìŠ¤íƒ€ì¼ ì ìš©
  if (event.category === 'todo' || event.id < -1000) {
    const colors =
      ASSIGNEE_COLORS[(event.assignee as keyof typeof ASSIGNEE_COLORS) || 'both'] ||
      ASSIGNEE_COLORS.both
    return {
      background: `linear-gradient(135deg, ${colors.background}dd, ${colors.background}aa)`,
      backgroundColor: `${colors.background}dd`,
      borderColor: colors.border,
      boxShadow: `0 1px 3px ${colors.shadow}`,
      borderStyle: 'dashed',
      borderWidth: '1px',
    }
  }

  const colors =
    ASSIGNEE_COLORS[(event.assignee as keyof typeof ASSIGNEE_COLORS) || 'both'] ||
    ASSIGNEE_COLORS.both

  return {
    background: colors.background,
    backgroundColor: colors.background,
    borderColor: colors.border,
    boxShadow: `0 2px 6px ${colors.shadow}`,
  }
}

function handleEventClick(event: CalendarEvent) {
  // ì˜ˆì‹ì¼ì€ í´ë¦­ ë¶ˆê°€
  if (event.id === -1) {
    return
  }
  
  // í• ì¼ í´ë¦­ (IDê°€ -1000 ë¯¸ë§Œì¸ ê²½ìš°)
  if (event.id < -1000) {
    const todoId = -event.id - 1000
    const todo = todos.value.find((t) => t.id === todoId)
    if (todo) {
      openTodoModal(todo)
    }
    return
  }
  
  // ì¼ë°˜ ì¼ì • í´ë¦­
  openEventModal(event)
}

function handleDateKeydown(event: KeyboardEvent, field: 'start_date' | 'due_date' | 'wedding_date') {
  const input = event.target as HTMLInputElement
  
  // ë°±ìŠ¤í˜ì´ìŠ¤, ì‚­ì œ, í™”ì‚´í‘œ í‚¤ ë“±ì€ í—ˆìš©
  if (['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Tab', 'Enter'].includes(event.key)) {
    return
  }
  
  // Ctrl/Cmd + A, C, V, X ë“±ì€ í—ˆìš©
  if (event.ctrlKey || event.metaKey) {
    return
  }
  
  // ìˆ«ìë§Œ í—ˆìš©
  if (!/^\d$/.test(event.key)) {
    event.preventDefault()
    return
  }
  
  const currentValue = input.value.replace(/\D/g, '') // ìˆ«ìë§Œ ì¶”ì¶œ
  const newValue = currentValue + event.key
  
  // ìµœëŒ€ 8ìë¦¬ê¹Œì§€ë§Œ í—ˆìš©
  if (newValue.length > 8) {
    event.preventDefault()
    return
  }
  
  // YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ìë™ í¬ë§·íŒ…
  let formatted = newValue
  if (newValue.length > 4) {
    formatted = newValue.slice(0, 4) + '-' + newValue.slice(4, 6)
  }
  if (newValue.length > 6) {
    formatted = newValue.slice(0, 4) + '-' + newValue.slice(4, 6) + '-' + newValue.slice(6, 8)
  }
  
  // ì—°ë„ 4ìë¦¬ ì…ë ¥ ì™„ë£Œ ì‹œ ìë™ìœ¼ë¡œ í•˜ì´í”ˆ ì¶”ê°€í•˜ê³  ì›” í•„ë“œë¡œ í¬ì»¤ìŠ¤ ì´ë™
  if (newValue.length === 4) {
    event.preventDefault()
    formatted = newValue + '-'
    updateDateValue(field, formatted)
    nextTick(() => {
      input.value = formatted
      const position = 5 // YYYY-|MM-DD
      input.setSelectionRange(position, position)
    })
    return
  }
  
  // ì›” 2ìë¦¬ ì…ë ¥ ì™„ë£Œ ì‹œ ìë™ìœ¼ë¡œ í•˜ì´í”ˆ ì¶”ê°€í•˜ê³  ì¼ í•„ë“œë¡œ í¬ì»¤ìŠ¤ ì´ë™
  if (newValue.length === 6) {
    event.preventDefault()
    formatted = newValue.slice(0, 4) + '-' + newValue.slice(4, 6) + '-'
    updateDateValue(field, formatted)
    nextTick(() => {
      input.value = formatted
      const position = formatted.length // YYYY-MM-|DD
      input.setSelectionRange(position, position)
    })
    return
  }
  
  // ì¼ë°˜ ì…ë ¥ ì‹œ í¬ë§·íŒ…ë§Œ ì ìš©
  event.preventDefault()
  formatted = formatDateValue(newValue)
  updateDateValue(field, formatted)
  nextTick(() => {
    input.value = formatted
    const position = formatted.length
    input.setSelectionRange(position, position)
  })
}

function formatDateValue(digits: string): string {
  if (digits.length <= 4) {
    return digits
  } else if (digits.length <= 6) {
    return digits.slice(0, 4) + '-' + digits.slice(4, 6)
  } else {
    return digits.slice(0, 4) + '-' + digits.slice(4, 6) + '-' + digits.slice(6, 8)
  }
}

function updateDateValue(field: 'start_date' | 'due_date' | 'wedding_date', value: string) {
  if (field === 'start_date') {
    eventForm.value.start_date = value
  } else if (field === 'due_date') {
    todoForm.value.due_date = value
  } else if (field === 'wedding_date') {
    weddingDate.value = value
  }
}

function handleDateInput(event: Event, field: 'start_date' | 'due_date' | 'wedding_date') {
  const input = event.target as HTMLInputElement
  const value = input.value
  
  // ì´ë¯¸ ì˜¬ë°”ë¥¸ í˜•ì‹ì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
  if (value.match(/^\d{4}-\d{2}-\d{2}$/)) {
    updateDateValue(field, value)
    return
  }
  
  // ìˆ«ìë§Œ ì¶”ì¶œí•˜ì—¬ í¬ë§·íŒ…
  const digits = value.replace(/\D/g, '').slice(0, 8)
  const formatted = formatDateValue(digits)
  updateDateValue(field, formatted)
  
  nextTick(() => {
    if (input.value !== formatted) {
      input.value = formatted
    }
  })
}

function handleDatePaste(event: ClipboardEvent, field: 'start_date' | 'due_date' | 'wedding_date') {
  event.preventDefault()
  const input = event.target as HTMLInputElement
  const pastedText = event.clipboardData?.getData('text') || ''
  const digits = pastedText.replace(/\D/g, '').slice(0, 8)
  const formatted = formatDateValue(digits)
  
  updateDateValue(field, formatted)
  
  nextTick(() => {
    input.value = formatted
    input.setSelectionRange(formatted.length, formatted.length)
  })
}
</script>

<template>
  <section class="section" id="calendar">
    <div class="container" style="display: flex; flex-direction: column; gap: 20px">
      <div class="page-title">
        <h1>ğŸ“… ê°œì¸í™” ì¼ì • ê´€ë¦¬(ìº˜ë¦°ë”)</h1>
        <p>D-Day ê¸°ë°˜ íƒ€ì„ë¼ì¸ ìë™ ìƒì„± + Todo ë¦¬ìŠ¤íŠ¸</p>
      </div>

      <!-- ì˜ˆì‹ì¼ ì„¤ì • -->
      <div class="card">
        <div class="wedding-date-section">
          <label style="font-weight: 600">ì˜ˆì‹ì¼:</label>
          <input
            type="text"
            id="weddingDateInput"
            :value="weddingDate || ''"
            placeholder="YYYY-MM-DD"
            maxlength="10"
            @keydown="handleDateKeydown($event, 'wedding_date')"
            @input="handleDateInput($event, 'wedding_date')"
            @paste="handleDatePaste($event, 'wedding_date')"
          />
          <button class="btn primary" type="button" @click="setWeddingDate">ì„¤ì •</button>
          <button class="btn" type="button" @click="generateTimeline">íƒ€ì„ë¼ì¸ ìë™ ìƒì„±</button>
          <label style="display: flex; align-items: center; gap: 8px; margin-left: 12px; cursor: pointer;">
            <input
              type="checkbox"
              v-model="showAutoGeneratedEvents"
              style="width: 18px; height: 18px; cursor: pointer;"
            />
            <span style="font-size: 14px; color: var(--text)">ìë™ ìƒì„± ì¼ì • í‘œì‹œ</span>
          </label>
        </div>
        <div v-if="dDay !== null" style="font-size: 18px; font-weight: 600; color: var(--accent); margin-top: 12px">
          <span v-if="dDay > 0">D-{{ dDay }}</span>
          <span v-else-if="dDay === 0">D-Day!</span>
          <span v-else>D+{{ Math.abs(dDay) }}</span>
        </div>
      </div>

      <!-- ìº˜ë¦°ë” -->
      <div class="card">
        <div class="calendar-header">
          <h2 style="margin: 0">ìº˜ë¦°ë”</h2>
          <div class="calendar-controls">
            <div class="month-navigation">
              <button class="btn month-btn" type="button" @click="prevMonth">â—€</button>
              <span class="month-text">{{ currentMonthText }}</span>
              <button class="btn month-btn" type="button" @click="nextMonth">â–¶</button>
            </div>
            <button class="btn primary" type="button" @click="openEventModal">ì¼ì • ì¶”ê°€</button>
          </div>
        </div>
        <!-- ì¼ì • ìƒ‰ìƒ ë²”ë¡€ -->
        <div style="display: flex; gap: 16px; margin-bottom: 16px; padding: 12px; background: var(--soft); border-radius: 8px; flex-wrap: wrap">
          <div style="display: flex; align-items: center; gap: 8px">
            <div style="width: 16px; height: 16px; border-radius: 4px; background: #3b82f6"></div>
            <span style="font-size: 13px; color: var(--text)">ì‹ ë‘ ì¼ì •</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px">
            <div style="width: 16px; height: 16px; border-radius: 4px; background: #ec4899"></div>
            <span style="font-size: 13px; color: var(--text)">ì‹ ë¶€ ì¼ì •</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px">
            <div style="width: 16px; height: 16px; border-radius: 4px; background: #8b5cf6"></div>
            <span style="font-size: 13px; color: var(--text)">ê³µë™ ì¼ì •</span>
          </div>
          <div style="display: flex; align-items: center; gap: 8px">
            <div style="width: 16px; height: 16px; border-radius: 4px; background: linear-gradient(135deg, var(--accent), var(--accent-2))"></div>
            <span style="font-size: 13px; color: var(--text)">ì˜ˆì‹ì¼</span>
          </div>
        </div>
        <div class="calendar-grid">
          <div
            v-for="dayName in ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ']"
            :key="dayName"
            style="text-align: center; font-weight: 600; padding: 8px"
          >
            {{ dayName }}
          </div>
          <div
            v-for="(day, idx) in calendarDays"
            :key="idx"
            class="calendar-day"
            :class="{
              'other-month': !day.isCurrentMonth,
              today: day.isToday,
              'selected-date': selectedDate === `${day.date.getFullYear()}-${String(day.date.getMonth() + 1).padStart(2, '0')}-${String(day.date.getDate()).padStart(2, '0')}`
            }"
            @click="handleDateClick(`${day.date.getFullYear()}-${String(day.date.getMonth() + 1).padStart(2, '0')}-${String(day.date.getDate()).padStart(2, '0')}`)"
          >
            <div class="day-number">{{ day.date.getDate() }}</div>
            <div
              v-for="event in day.events"
              :key="`${event.id}-${event.start_date}`"
              class="event-item"
              :class="[
                getPriorityClass(event.priority),
                getAssigneeClass(event.assignee),
                { 
                  'wedding-event': event.category === 'wedding' || event.id === -1,
                  'todo-event': event.category === 'todo' || event.id < -1000
                }
              ]"
              :style="getEventStyle(event)"
              :title="event.description || event.title"
              @click.stop="handleEventClick(event)"
            >
              {{ event.title }}
            </div>
          </div>
        </div>
      </div>

      <!-- Todo ë¦¬ìŠ¤íŠ¸ -->
      <div class="card todo-section">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; gap: 16px">
          <div style="flex: 1; min-width: 0;">
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <h2 style="margin: 0">í• ì¼ ë¦¬ìŠ¤íŠ¸</h2>
              <span v-if="selectedDate" style="font-size: 14px; color: var(--accent-2); font-weight: 600;">
                ({{ selectedDate }})
              </span>
              <button
                v-if="selectedDate"
                type="button"
                @click="selectedDate = null; loadTodos()"
                style="
                  padding: 4px 8px;
                  background: var(--soft);
                  border: 1px solid var(--line);
                  border-radius: 4px;
                  color: var(--muted);
                  font-size: 12px;
                  cursor: pointer;
                  transition: all 0.2s;
                "
                @mouseenter="(e) => { e.currentTarget.style.background = 'var(--danger)'; e.currentTarget.style.color = '#fff'; }"
                @mouseleave="(e) => { e.currentTarget.style.background = 'var(--soft)'; e.currentTarget.style.color = 'var(--muted)'; }"
              >
                í•„í„° í•´ì œ
              </button>
            </div>
            <p style="margin: 0; font-size: 13px; color: var(--muted); line-height: 1.5">
              <strong>ğŸ“… ì¼ì • vs ğŸ“‹ í• ì¼:</strong> ì¼ì •ì€ íŠ¹ì • ë‚ ì§œì™€ ì‹œê°„ì— ê³ ì •ëœ ì´ë²¤íŠ¸(ì˜ˆ: ì›¨ë”©í™€ ë°©ë¬¸, ë“œë ˆìŠ¤ í”¼íŒ…)ì´ê³ , 
              í• ì¼ì€ ë§¤ì¼ë§¤ì¼ ì‘ê²Œ ìŒ“ì´ëŠ” ì²´í¬ë¦¬ìŠ¤íŠ¸(ì˜ˆ: ì²­ì²©ì¥ ì£¼ë¬¸ í™•ì¸, í•˜ê° ëª…ë‹¨ ì‘ì„±)ì…ë‹ˆë‹¤. 
              í• ì¼ì€ ë§ˆê°ì¼ì´ ì„¤ì •ë˜ë©´ ìº˜ë¦°ë”ì—ë„ í‘œì‹œë©ë‹ˆë‹¤.
              <span v-if="selectedDate" style="display: block; margin-top: 4px; color: var(--accent-2);">
                ğŸ’¡ ìº˜ë¦°ë”ì—ì„œ ë‚ ì§œë¥¼ í´ë¦­í•˜ë©´ í•´ë‹¹ ë‚ ì§œì˜ ì¼ì •ë§Œ í‘œì‹œë©ë‹ˆë‹¤.
              </span>
            </p>
          </div>
          <button class="btn primary" type="button" @click="openTodoModal" style="white-space: nowrap; flex-shrink: 0; align-self: flex-start;">í• ì¼ ì¶”ê°€</button>
        </div>
        <div v-if="todos.length === 0" style="text-align: center; color: var(--muted); padding: 40px">
          í• ì¼ì´ ì—†ìŠµë‹ˆë‹¤.
        </div>
        <div v-else>
          <div
            v-for="todo in todos"
            :key="todo.id"
            class="todo-item"
            :class="{ completed: todo.is_completed }"
          >
            <div
              class="todo-checkbox"
              :class="{ checked: todo.is_completed }"
              @click.stop="toggleTodo(todo.id)"
            ></div>
            <div style="flex: 1; cursor: pointer" @click.stop="openTodoModal(todo)">
              <div style="font-weight: 600; margin-bottom: 4px">{{ todo.title }}</div>
              <div v-if="todo.due_date" style="font-size: 12px; color: var(--muted)">
                ë§ˆê°: {{ todo.due_date }}
              </div>
            </div>
            <div
              style="
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                background: var(--danger);
              "
              :style="{
                background:
                  todo.priority === 'high'
                    ? 'var(--danger)'
                    : todo.priority === 'medium'
                    ? 'var(--warn)'
                    : 'var(--ok)',
              }"
            >
              {{ todo.priority === 'high' ? 'ë†’ìŒ' : todo.priority === 'medium' ? 'ë³´í†µ' : 'ë‚®ìŒ' }}
            </div>
            <div style="display: flex; gap: 6px; align-items: center; flex-shrink: 0;">
              <button
                type="button"
                @click.stop="openTodoModal(todo)"
                title="ìˆ˜ì •"
                style="
                  padding: 6px 10px;
                  background: var(--soft);
                  border: 1px solid var(--line);
                  border-radius: 6px;
                  color: var(--accent-2);
                  cursor: pointer;
                  transition: all 0.2s;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 13px;
                  font-weight: 500;
                  white-space: nowrap;
                "
                @mouseenter="(e) => { e.currentTarget.style.background = 'var(--accent)'; e.currentTarget.style.color = '#fff'; e.currentTarget.style.borderColor = 'var(--accent)'; }"
                @mouseleave="(e) => { e.currentTarget.style.background = 'var(--soft)'; e.currentTarget.style.color = 'var(--accent-2)'; e.currentTarget.style.borderColor = 'var(--line)'; }"
              >
                ìˆ˜ì •
              </button>
              <button
                type="button"
                @click.stop="deleteTodo(todo.id)"
                title="ì‚­ì œ"
                style="
                  padding: 6px 10px;
                  background: var(--soft);
                  border: 1px solid var(--line);
                  border-radius: 6px;
                  color: var(--danger);
                  cursor: pointer;
                  transition: all 0.2s;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  font-size: 13px;
                  font-weight: 500;
                  white-space: nowrap;
                "
                @mouseenter="(e) => { e.currentTarget.style.background = 'var(--danger)'; e.currentTarget.style.color = '#fff'; e.currentTarget.style.borderColor = 'var(--danger)'; }"
                @mouseleave="(e) => { e.currentTarget.style.background = 'var(--soft)'; e.currentTarget.style.color = 'var(--danger)'; e.currentTarget.style.borderColor = 'var(--line)'; }"
              >
                ì‚­ì œ
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ì¼ì • ì¶”ê°€ ëª¨ë‹¬ -->
    <div v-if="showEventModal" class="modal-overlay" @click.self="closeEventModal">
      <div class="modal-card">
        <h3 style="margin-top: 0">{{ editingEventId ? 'ì¼ì • ìˆ˜ì •' : 'ì¼ì • ì¶”ê°€' }}</h3>
        <div class="form-group">
          <label>ì œëª©</label>
          <input v-model="eventForm.title" type="text" required />
        </div>
        <div class="form-group">
          <label>ë‚ ì§œ</label>
          <div class="input-with-icon">
            <input
              :value="eventForm.start_date"
              type="text"
              required
              placeholder="YYYY-MM-DD"
              maxlength="10"
              @keydown="handleDateKeydown($event, 'start_date')"
              @input="handleDateInput($event, 'start_date')"
              @paste="handleDatePaste($event, 'start_date')"
            />
            <span class="input-icon">ğŸ“…</span>
          </div>
        </div>
        <div class="form-group">
          <label>ì‹œê°„</label>
          <div style="display: flex; gap: 8px; align-items: center">
            <div style="display: flex; gap: 4px; align-items: center; flex: 1">
              <input
                v-model="eventForm.timeHour"
                type="text"
                placeholder="ì‹œ"
                maxlength="2"
                style="width: 60px; text-align: center"
                @input="(e) => {
                  const value = (e.target as HTMLInputElement).value.replace(/\D/g, '')
                  if (value.length > 2) {
                    eventForm.timeHour = value.slice(0, 2)
                  } else {
                    eventForm.timeHour = value
                  }
                  const hourNum = parseInt(value, 10)
                  if (!isNaN(hourNum)) {
                    // 13ì‹œ ì´ìƒì´ë©´ ìë™ìœ¼ë¡œ ì˜¤í›„ë¡œ ë³€ê²½í•˜ê³  12ì‹œê°„ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                    if (hourNum >= 13 && hourNum <= 23) {
                      eventForm.timePeriod = 'PM'
                      eventForm.timeHour = String(hourNum - 12)
                    } else if (hourNum === 0) {
                      eventForm.timePeriod = 'AM'
                      eventForm.timeHour = '12'
                    } else if (hourNum > 23) {
                      eventForm.timeHour = '12'
                    } else if (hourNum > 12) {
                      eventForm.timeHour = '12'
                    }
                  }
                }"
              />
              <span style="color: var(--muted)">:</span>
              <input
                v-model="eventForm.timeMinute"
                type="text"
                placeholder="ë¶„"
                maxlength="2"
                style="width: 60px; text-align: center"
                @input="(e) => {
                  const value = (e.target as HTMLInputElement).value.replace(/\D/g, '')
                  if (value.length > 2) {
                    eventForm.timeMinute = value.slice(0, 2)
                  } else {
                    eventForm.timeMinute = value
                  }
                  const minuteNum = parseInt(value, 10)
                  if (!isNaN(minuteNum) && minuteNum > 59) {
                    eventForm.timeMinute = '59'
                  }
                }"
              />
            </div>
            <div style="display: flex; gap: 4px">
              <button
                type="button"
                class="btn"
                :class="{ primary: eventForm.timePeriod === 'AM' }"
                style="padding: 8px 16px; min-width: 60px"
                @click="eventForm.timePeriod = 'AM'"
              >
                ì˜¤ì „
              </button>
              <button
                type="button"
                class="btn"
                :class="{ primary: eventForm.timePeriod === 'PM' }"
                style="padding: 8px 16px; min-width: 60px"
                @click="eventForm.timePeriod = 'PM'"
              >
                ì˜¤í›„
              </button>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label>ì¹´í…Œê³ ë¦¬</label>
          <select v-model="eventForm.category">
            <option value="general">ì¼ë°˜</option>
            <option value="todo">í• ì¼</option>
            <option value="payment">ê²°ì œ</option>
            <option value="meeting">ë¯¸íŒ…</option>
            <option value="fitting">í”¼íŒ…</option>
            <option value="booking">ì˜ˆì•½</option>
            <option value="preparation">ì¤€ë¹„</option>
          </select>
        </div>
        <div class="form-group">
          <label>ìš°ì„ ìˆœìœ„</label>
          <select v-model="eventForm.priority">
            <option value="low">ë‚®ìŒ</option>
            <option value="medium">ë³´í†µ</option>
            <option value="high">ë†’ìŒ</option>
          </select>
        </div>
        <div class="form-group">
          <label>ë‹´ë‹¹ì</label>
          <select v-model="eventForm.assignee">
            <option value="both">ê³µë™</option>
            <option value="groom">ì‹ ë‘</option>
            <option value="bride">ì‹ ë¶€</option>
          </select>
        </div>
        <div style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px">
          <button class="btn" type="button" @click="closeEventModal">ì·¨ì†Œ</button>
          <button
            v-if="editingEventId"
            class="btn danger"
            type="button"
            @click="deleteEvent(editingEventId)"
          >
            ì‚­ì œ
          </button>
          <button class="btn primary" type="button" @click="createEvent">
            {{ editingEventId ? 'ìˆ˜ì •' : 'ì¶”ê°€' }}
          </button>
        </div>
      </div>
    </div>

  </section>
</template>

<style scoped>
.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  gap: 16px;
}

.calendar-controls {
  display: flex;
  gap: 12px;
  align-items: center;
}

.month-navigation {
  display: flex;
  align-items: center;
  gap: 8px;
}

.month-btn {
  padding: 8px 12px;
  min-width: 40px;
  font-size: 16px;
  font-weight: 600;
}

.month-text {
  padding: 10px 16px;
  font-weight: 600;
  font-size: 16px;
  color: var(--text);
  min-width: 140px;
  text-align: center;
}

.wedding-date-section {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-bottom: 24px;
  padding: 16px;
  background: rgba(139, 92, 246, 0.1);
  border-radius: 12px;
}

.wedding-date-section input {
  padding: 10px;
  border-radius: 8px;
  background: var(--soft);
  border: 1px solid rgba(255, 255, 255, 0.1);
  color: var(--text);
  font-size: 14px;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 8px;
  margin-bottom: 20px;
}

.calendar-day {
  background: var(--soft);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  padding: 12px;
  min-height: 100px;
  position: relative;
}

.calendar-day.other-month {
  opacity: 0.3;
}

.calendar-day.today {
  border-color: var(--accent);
  background: rgba(139, 92, 246, 0.1);
}

.calendar-day.selected-date {
  border-color: var(--accent-2);
  background: rgba(34, 211, 238, 0.15);
  border-width: 2px;
  cursor: pointer;
}

.calendar-day:hover {
  background: rgba(255, 255, 255, 0.05);
  cursor: pointer;
}

.calendar-day.selected-date:hover {
  background: rgba(34, 211, 238, 0.2);
}

.day-number {
  font-weight: 600;
  margin-bottom: 8px;
}

.event-item {
  font-size: 12px;
  padding: 6px 10px;
  background: var(--accent);
  border-radius: 6px;
  margin-bottom: 4px;
  cursor: pointer;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  color: #ffffff !important;
  font-weight: 600;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  transition: all 0.2s ease;
  border: 1px solid rgba(255, 255, 255, 0.15);
  min-height: 24px;
  display: flex;
  align-items: center;
}

.event-item:hover {
  transform: translateY(-1px);
  box-shadow: 0 3px 8px rgba(0, 0, 0, 0.4);
  border-color: rgba(255, 255, 255, 0.3);
}

/* ë‹´ë‹¹ìë³„ ìƒ‰ìƒ (ìš°ì„ ìˆœìœ„ë³´ë‹¤ ìš°ì„ ) - ë²”ë¡€ì™€ ì •í™•íˆ ë™ì¼í•œ ìƒ‰ìƒ */
.event-item.assignee-groom,
.calendar-day .event-item.assignee-groom {
  background: #3b82f6 !important; /* íŒŒë€ìƒ‰ - ì‹ ë‘ (ë²”ë¡€ì™€ ë™ì¼) */
  background-color: #3b82f6 !important;
  color: #ffffff !important;
  font-weight: 600;
  border: 1px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4);
}

.event-item.assignee-bride,
.calendar-day .event-item.assignee-bride {
  background: #ec4899 !important; /* í•‘í¬ìƒ‰ - ì‹ ë¶€ (ë²”ë¡€ì™€ ë™ì¼) */
  background-color: #ec4899 !important;
  color: #ffffff !important;
  font-weight: 600;
  border: 1px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 2px 6px rgba(236, 72, 153, 0.4);
}

.event-item.assignee-both,
.calendar-day .event-item.assignee-both {
  background: #8b5cf6 !important; /* ë³´ë¼ìƒ‰ - ê³µë™ (ë²”ë¡€ì™€ ë™ì¼) */
  background-color: #8b5cf6 !important;
  color: #ffffff !important;
  font-weight: 600;
  border: 1px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 2px 6px rgba(139, 92, 246, 0.4);
}

/* ìš°ì„ ìˆœìœ„ë³„ íˆ¬ëª…ë„ ì¡°ì • - ê°€ë…ì„±ì„ ìœ„í•´ íˆ¬ëª…ë„ ì œê±° */
.event-item.assignee-groom.high,
.event-item.assignee-bride.high,
.event-item.assignee-both.high,
.event-item.assignee-groom.medium,
.event-item.assignee-bride.medium,
.event-item.assignee-both.medium,
.event-item.assignee-groom.low,
.event-item.assignee-bride.low,
.event-item.assignee-both.low {
  opacity: 1;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
}

/* ë‹´ë‹¹ìê°€ ì—†ëŠ” ê²½ìš° ìš°ì„ ìˆœìœ„ ìƒ‰ìƒ ì‚¬ìš© */
.event-item.high:not(.assignee-groom):not(.assignee-bride):not(.assignee-both):not(.wedding-date) {
  background: var(--danger) !important;
  color: #ffffff !important;
  font-weight: 600;
}

/* ë‹¤í¬ ëª¨ë“œì—ì„œ ë” ë°ê²Œ */
[data-theme="dark"] .event-item.high:not(.assignee-groom):not(.assignee-bride):not(.assignee-both):not(.wedding-date) {
  background: #f87171 !important; /* ë” ë°ì€ ë¹¨ê°„ìƒ‰ */
  box-shadow: 0 2px 6px rgba(248, 113, 113, 0.4);
}

.event-item.medium:not(.assignee-groom):not(.assignee-bride):not(.assignee-both):not(.wedding-date) {
  background: var(--warn) !important;
  color: #ffffff !important;
  font-weight: 600;
}

/* ë‹¤í¬ ëª¨ë“œì—ì„œ ë” ë°ê²Œ */
[data-theme="dark"] .event-item.medium:not(.assignee-groom):not(.assignee-bride):not(.assignee-both):not(.wedding-date) {
  background: #fbbf24 !important; /* ë” ë°ì€ ë…¸ë€ìƒ‰ */
  box-shadow: 0 2px 6px rgba(251, 191, 36, 0.4);
}

.event-item.low:not(.assignee-groom):not(.assignee-bride):not(.assignee-both):not(.wedding-date) {
  background: var(--ok) !important;
  color: #ffffff !important;
  font-weight: 600;
}

/* ë‹¤í¬ ëª¨ë“œì—ì„œ ë” ë°ê²Œ */
[data-theme="dark"] .event-item.low:not(.assignee-groom):not(.assignee-bride):not(.assignee-both):not(.wedding-date) {
  background: #34d399 !important; /* ë” ë°ì€ ì´ˆë¡ìƒ‰ */
  box-shadow: 0 2px 6px rgba(52, 211, 153, 0.4);
}

/* ì˜ˆì‹ì¼ ì´ë²¤íŠ¸ íŠ¹ë³„ ìŠ¤íƒ€ì¼ */
.event-item.wedding-event,
.event-item.wedding-date {
  background: linear-gradient(135deg, var(--accent), var(--accent-2)) !important;
  color: #ffffff !important;
  font-weight: 700;
  font-size: 13px;
  box-shadow: 0 2px 8px rgba(var(--accent-rgb), 0.5);
  transform: scale(1.02);
  transition: all 0.2s ease;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
  cursor: default;
}

/* ë¼ì´íŠ¸ ëª¨ë“œì—ì„œ ì˜ˆì‹ì¼ ìƒ‰ìƒ ë” ì§„í•˜ê²Œ */
[data-theme="light"] .event-item.wedding-event,
[data-theme="light"] .event-item.wedding-date {
  background: linear-gradient(135deg, #b8860b, #daa520) !important; /* ë” ì§„í•œ ê³¨ë“œ ìƒ‰ìƒ */
  box-shadow: 0 2px 8px rgba(184, 134, 11, 0.4);
}

.event-item.wedding-event:hover,
.event-item.wedding-date:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(var(--accent-rgb), 0.6);
}

[data-theme="light"] .event-item.wedding-event:hover,
[data-theme="light"] .event-item.wedding-date:hover {
  box-shadow: 0 4px 12px rgba(184, 134, 11, 0.5);
}

.todo-section {
  margin-top: 24px;
}

.todo-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  background: var(--soft);
  border-radius: 8px;
  margin-bottom: 8px;
}

.todo-item.completed {
  opacity: 0.5;
}

.todo-checkbox {
  width: 20px;
  height: 20px;
  border-radius: 4px;
  border: 2px solid var(--accent);
  cursor: pointer;
}

.todo-checkbox.checked {
  background: var(--accent);
}

.form-group select {
  width: 100%;
  padding: 10px 12px;
  border-radius: 8px;
  background: var(--soft);
  border: 1px solid rgba(255, 255, 255, 0.1);
  color: var(--text);
  font-size: 14px;
  font-family: inherit;
  cursor: pointer;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a7b0c0' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 36px;
  transition: 0.2s;
}

.form-group select:hover {
  border-color: rgba(255, 255, 255, 0.2);
}

.form-group select:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
}

[data-theme='light'] .form-group select {
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%235d6175' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
}

.input-with-icon {
  position: relative;
  width: 100%;
}

.input-with-icon input {
  width: 100%;
  padding: 10px 36px 10px 12px;
  border-radius: 8px;
  background: var(--soft);
  border: 1px solid rgba(255, 255, 255, 0.1);
  color: var(--text);
  font-size: 14px;
  font-family: inherit;
}

.input-icon {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  pointer-events: none;
  font-size: 16px;
}

/* ëª¨ë°”ì¼ ìŠ¤íƒ€ì¼ */
@media (max-width: 768px) {
  .section {
    padding: 16px 8px;
  }

  .container {
    padding: 0 12px;
  }

  .page-title h1 {
    font-size: 22px;
    margin-bottom: 6px;
    font-weight: 700;
  }

  .page-title p {
    font-size: 14px;
  }

  .card {
    padding: 16px;
    margin-bottom: 16px;
  }

  .card h2 {
    font-size: 18px;
    font-weight: 600;
  }

  .wedding-date-section {
    flex-direction: column;
    gap: 10px;
    padding: 14px;
    margin-bottom: 16px;
  }

  .wedding-date-section label {
    width: 100%;
    margin-left: 0;
    font-size: 15px;
    font-weight: 600;
  }

  .wedding-date-section input {
    width: 100%;
    padding: 12px;
    font-size: 16px;
  }

  .wedding-date-section button {
    width: 100%;
    font-size: 15px;
    padding: 12px;
    min-height: 48px;
  }

  .wedding-date-section > div[style*="font-size: 18px"] {
    font-size: 20px !important;
    font-weight: 700;
  }

  .calendar-header {
    flex-direction: column;
    gap: 12px;
    align-items: flex-start;
  }

  .calendar-header h2 {
    font-size: 18px;
  }

  .calendar-controls {
    width: 100%;
    flex-direction: column;
    gap: 10px;
  }

  .month-navigation {
    width: 100%;
    justify-content: center;
    gap: 12px;
  }

  .month-btn {
    width: 48px;
    height: 48px;
    font-size: 18px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .month-text {
    font-size: 18px;
    font-weight: 700;
    padding: 12px 20px;
    min-width: auto;
    flex: 1;
    text-align: center;
  }

  .calendar-controls > .btn.primary {
    width: 100%;
    font-size: 15px;
    padding: 12px;
  }

  .card > div[style*="display: flex"][style*="gap: 16px"][style*="flex-wrap"] {
    font-size: 13px;
  }

  .card > div[style*="display: flex"][style*="gap: 16px"][style*="flex-wrap"] > div {
    font-size: 13px;
  }

  .card > div[style*="display: flex"][style*="gap: 16px"][style*="flex-wrap"] > div > div {
    font-size: 13px;
  }

  .card > div[style*="display: flex"][style*="gap: 16px"][style*="flex-wrap"] > div > span {
    font-size: 13px;
  }

  .calendar-grid {
    gap: 4px;
  }

  .calendar-grid > div[style*="text-align: center"] {
    font-size: 14px;
    font-weight: 600;
    padding: 10px 4px;
  }

  .calendar-day {
    padding: 8px 4px;
    min-height: 70px;
  }

  .day-number {
    font-size: 15px;
    font-weight: 700;
    margin-bottom: 6px;
  }

  .event-item {
    font-size: 11px;
    padding: 5px 6px;
    margin-bottom: 3px;
    min-height: 22px;
    font-weight: 600;
    line-height: 1.3;
  }

  .todo-section {
    margin-top: 16px;
  }

  .todo-section h2 {
    font-size: 18px;
    font-weight: 600;
  }

  .todo-section > div[style*="display: flex"] > div > div[style*="display: flex"] > span {
    font-size: 14px;
    font-weight: 600;
  }

  .todo-section > div[style*="display: flex"] > div > p {
    font-size: 13px;
    line-height: 1.6;
  }

  .todo-item {
    padding: 12px;
    gap: 10px;
    flex-wrap: wrap;
  }

  .todo-checkbox {
    width: 20px;
    height: 20px;
  }

  .todo-item > div[style*="flex: 1"] > div[style*="font-weight: 600"] {
    font-size: 15px;
    font-weight: 600;
  }

  .todo-item > div[style*="flex: 1"] > div[style*="font-size: 12px"] {
    font-size: 13px;
  }

  .todo-item > div[style*="padding: 4px 8px"] {
    font-size: 12px;
    padding: 6px 10px;
  }

  .todo-item > div[style*="display: flex"][style*="gap: 6px"] {
    flex-direction: column;
    gap: 8px;
    width: 100%;
  }

  .todo-item > div[style*="display: flex"][style*="gap: 6px"] > button {
    width: 100%;
    font-size: 14px;
    padding: 10px;
    min-height: 44px;
  }

  .modal-card {
    padding: 20px 16px;
    width: 95%;
    max-width: none;
  }

  .modal-card h3 {
    font-size: 20px;
    font-weight: 700;
  }

  .form-group {
    margin-bottom: 14px;
  }

  .form-group label {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 8px;
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    padding: 12px;
    font-size: 16px;
  }

  .form-group > div[style*="display: flex"] {
    flex-direction: column;
    gap: 10px;
  }

  .form-group > div[style*="display: flex"] > div {
    width: 100%;
  }

  .form-group > div[style*="display: flex"] > button {
    width: 100%;
    font-size: 14px;
    padding: 12px;
  }

  .btn {
    padding: 12px 16px;
    font-size: 15px;
    min-height: 48px;
  }

  .card > div[style*="display: flex"] {
    flex-direction: column;
    gap: 10px;
  }

  .card > div[style*="display: flex"] > button {
    width: 100%;
    font-size: 15px;
    padding: 12px;
  }
}

@media (max-width: 480px) {
  .page-title h1 {
    font-size: 20px;
  }

  .card h2 {
    font-size: 16px;
  }

  .calendar-day {
    min-height: 65px;
    padding: 6px 3px;
  }

  .day-number {
    font-size: 14px;
  }

  .event-item {
    font-size: 10px;
    padding: 4px 5px;
    min-height: 20px;
  }

  .calendar-grid > div[style*="text-align: center"] {
    font-size: 12px;
    padding: 8px 2px;
  }

  .todo-item > div[style*="flex: 1"] > div[style*="font-weight: 600"] {
    font-size: 14px;
  }
}
</style>
